\usetikzlibrary{lindenmayersystems}

\newif\ifpenrose@tiles
\newdimen\pr@origstep

\pgfkeys{
  /pgf/lindenmayer system/Penrose/tiles/.is if=penrose@tiles,
}
\def\pr@maybedraw{%
  \ifpenrose@tiles
  \expandafter\pgflsystemmoveforward
  \else
  \expandafter\pgflsystemdrawforward
  \fi
}

\pgfdeclarelindenmayersystem{Penrose Rhombus}{%
  % Triangle, clockwise
  \symbol{T}{
    \pgfpathmoveto{\pgfpointorigin}
    \pgflsystemdrawforward
    \ifpenrose@tiles
      \def\pgflsystemleftangle{36}
      \pgflsystemturnleft
      \pgflsystemdrawforward
      \def\pgflsystemleftangle{144}
      \pgflsystemturnleft
      \pgflsystemdrawforward
      \def\pgflsystemleftangle{36}
    \else
      \def\pgflsystemleftangle{108}
      \pgflsystemturnleft
      \pr@origstep=\pgflsystemstep
      \pgfmathsetlength\pgflsystemstep{2*sin(18)*\pgflsystemstep}
      \pgflsystemdrawforward
      \pgflsystemstep=\pr@origstep
      \def\pgflsystemleftangle{108}
    \fi
    \pgflsystemturnleft
    \pgflsystemdrawforward
  }
  % Triangle, anticlockwise
  \symbol{t}{
    \pr@maybedraw
    \def\pgflsystemleftangle{-108}
    \pgflsystemturnleft
    \pr@origstep=\pgflsystemstep
    \pgfmathsetlength\pgflsystemstep{2*sin(18)*\pgflsystemstep}
    \pr@maybedraw
    \pgflsystemstep=\pr@origstep
    \def\pgflsystemleftangle{-108}
    \pgflsystemturnleft
    \pr@maybedraw
  }
  % Gnomon, clockwise
  \symbol{G}{
    \pgfpathmoveto{\pgfpointorigin}
    \ifpenrose@tiles
      \def\pgflsystemleftangle{-36}
      \pgflsystemturnleft
      \pr@origstep=\pgflsystemstep
      \pgfmathsetlength\pgflsystemstep{\pgflsystemstep/(2*cos(36))}
      \pgflsystemdrawforward
      \def\pgflsystemleftangle{72}
      \pgflsystemturnleft
      \pgflsystemdrawforward
      \pgflsystemstep=\pr@origstep
      \def\pgflsystemleftangle{108}
    \else
      \pgflsystemdrawforward
      \def\pgflsystemleftangle{144}
    \fi
    \pgflsystemturnleft
    \pr@origstep=\pgflsystemstep
    \pgfmathsetlength\pgflsystemstep{\pgflsystemstep/(2*cos(36))}
    \pgflsystemdrawforward
    \def\pgflsystemleftangle{72}
    \pgflsystemturnleft
    \pgflsystemdrawforward
    \pgflsystemstep=\pr@origstep
    \pgfpathclose{\pgfpointorigin}
  }
  % Gnomon, anticlockwise
  \symbol{g}{
    \pr@maybedraw
    \def\pgflsystemleftangle{-144}
    \pgflsystemturnleft
    \pr@origstep=\pgflsystemstep
    \pgfmathsetlength\pgflsystemstep{\pgflsystemstep/(2*cos(36))}
    \pr@maybedraw
    \def\pgflsystemleftangle{-72}
    \pgflsystemturnleft
    \pr@maybedraw
    \pgflsystemstep=\pr@origstep
  }
  \symbol{s}{
    \pgfmathsetlength\pgflsystemstep{2*sin(18)*\pgflsystemstep}
  }
  \symbol{+}{
    \def\pgflsystemleftangle{144}
    \pgflsystemturnleft
  }
  \symbol{*}{
    \def\pgflsystemleftangle{108}
    \pgflsystemturnleft
  }
  \symbol{-}{
    \def\pgflsystemrightangle{144}
    \pgflsystemturnright
  }
  \symbol{_}{
    \def\pgflsystemrightangle{108}
    \pgflsystemturnright
  }
  \symbol{>}{
    \def\pgflsystemrightangle{180}
    \pgflsystemturnright
  }
  \rule{T -> [f*sT][f>g]}
  \rule{t -> [f_st][f>G]}
  \rule{G -> [f+sG][sf>g][sf*sT]}
  \rule{g -> [f-sg][sf>G][sf_st]}
}

\pgfdeclarelindenmayersystem{Penrose Kite}{%
  % Triangle, clockwise
  \symbol{T}{
    \pgfpathmoveto{\pgfpointorigin}
    \pgflsystemdrawforward
    \def\pgflsystemleftangle{108}
    \pgflsystemturnleft
    \pr@origstep=\pgflsystemstep
    \pgfmathsetlength\pgflsystemstep{2*sin(18)*\pgflsystemstep}
    \pgflsystemdrawforward
    \pgflsystemstep=\pr@origstep
    \ifpenrose@tiles
      \def\pgflsystemleftangle{36}
      \pgflsystemturnleft
      \pr@origstep=\pgflsystemstep
      \pgfmathsetlength\pgflsystemstep{2*sin(18)*\pgflsystemstep}
      \pgflsystemdrawforward
      \pgflsystemstep=\pr@origstep
      \def\pgflsystemleftangle{108}
      \pgflsystemturnleft
      \pgflsystemdrawforward
      \pgfclosepath{\pgfpointorigin}
    \else
      \def\pgflsystemleftangle{108}
      \pgflsystemturnleft
      \pgflsystemdrawforward
    \fi
  }
  % Triangle, anticlockwise
  \symbol{t}{
    \pr@maybedraw
    \def\pgflsystemleftangle{-108}
    \pgflsystemturnleft
    \pr@origstep=\pgflsystemstep
    \pgfmathsetlength\pgflsystemstep{2*sin(18)*\pgflsystemstep}
    \pr@maybedraw
    \pgflsystemstep=\pr@origstep
    \def\pgflsystemleftangle{-108}
    \pgflsystemturnleft
    \pr@maybedraw
  }
  % Gnomon, clockwise
  \symbol{G}{
    \pgfpathmoveto{\pgfpointorigin}
    \pgflsystemdrawforward
    \def\pgflsystemleftangle{144}
    \pgflsystemturnleft
    \pr@origstep=\pgflsystemstep
    \pgfmathsetlength\pgflsystemstep{\pgflsystemstep/(2*cos(36))}
    \pgflsystemdrawforward
    \ifpenrose@tiles
      \def\pgflsystemleftangle{-36}
      \pgflsystemturnleft
      \pgflsystemdrawforward
      \pgflsystemstep=\pr@origstep
      \def\pgflsystemleftangle{-216}
      \pgflsystemturnleft
      \pgflsystemdrawforward
      \pgfclosepath{\pgfpointorigin}
    \else
      \def\pgflsystemleftangle{72}
      \pgflsystemturnleft
      \pr@maybedraw
      \pgflsystemstep=\pr@origstep
    \fi
  }
  % Gnomon, anticlockwise
  \symbol{g}{
    \pr@maybedraw
    \def\pgflsystemleftangle{-144}
    \pgflsystemturnleft
    \pr@origstep=\pgflsystemstep
    \pgfmathsetlength\pgflsystemstep{\pgflsystemstep/(2*cos(36))}
    \pr@maybedraw
    \def\pgflsystemleftangle{-72}
    \pgflsystemturnleft
    \pr@maybedraw
    \pgflsystemstep=\pr@origstep
  }
  \symbol{s}{
    \pgfmathsetlength\pgflsystemstep{2*sin(18)*\pgflsystemstep}
  }
  \symbol{+}{
    \def\pgflsystemleftangle{36}
    \pgflsystemturnleft
  }
  \symbol{-}{
    \def\pgflsystemrightangle{36}
    \pgflsystemturnright
  }
  \rule{T -> [f+++sT][f+++++st][+sg]}
  \rule{t -> [f---st][f-----sT][-sG]}
  \rule{G -> [f++++sG][sT]}
  \rule{g -> [f----sg][st]}
}
