\RequirePackage{spath3}

\pgfmathsetmacro\pr@chphi{cos(18)}
\pgfmathsetmacro\pr@shphi{sin(18)}
\pgfmathsetmacro\pr@cphi{cos(36)}
\pgfmathsetmacro\pr@sphi{sin(36)}
\pgfmathsetmacro\pr@invphi{2/(sqrt(5)+1)}
\pgfmathsetmacro\pr@invphisq{\pr@invphi*\pr@invphi}
\pgfmathsetmacro\pr@ominvphisq{\pr@invphi - \pr@invphisq}
\pgfmathsetmacro\pr@ominvphi{1 - \pr@invphi}

\ExplSyntaxOn

\MakeSPath{Penrose path a} {\pgfsyssoftpath@movetotoken{0pt}{0pt}\pgfsyssoftpath@linetotoken{1pt}{0pt}}
\MakeSPath{Penrose path b} {\pgfsyssoftpath@movetotoken{0pt}{0pt}\pgfsyssoftpath@linetotoken{1pt}{0pt}}

\fp_new:N \l__penrose_tmpa_fp
\tl_new:N \l__penrose_tmpa_tl
\tl_new:N \l__penrose_tmpb_tl

\cs_new_nopar:Npn \penrose_normalise_path:n #1
{
  \spath_get:nnN {#1} {initial point} \l_tmpa_tl
  \fp_set:Nn \l_tmpa_fp {\tl_head:N \l_tmpa_tl}
  \tl_set:Nx \l_tmpa_tl {\tl_tail:N \l_tmpa_tl}
  \fp_set:Nn \l_tmpb_fp {\tl_head:N \l_tmpa_tl}
  \spath_get:nnN {#1} {final point} \l_tmpa_tl
  \fp_set:Nn \l_tmpa_fp {\tl_head:N \l_tmpa_tl - \l_tmpa_fp}
  \tl_set:Nx \l_tmpa_tl {\tl_tail:N \l_tmpa_tl}
  \fp_set:Nn \l_tmpb_fp {\tl_head:N \l_tmpa_tl - \l_tmpb_fp}
  \fp_set:Nn \l__penrose_tmpa_fp {\l_tmpa_fp^2 + \l_tmpb_fp^2}
  \fp_set:Nn \l_tmpa_fp {\l_tmpa_fp/\l__penrose_tmpa_fp}
  \fp_set:Nn \l_tmpb_fp {\l_tmpb_fp/\l__penrose_tmpa_fp}
  \fp_set:Nn \l__penrose_tmpa_fp {-\l_tmpb_fp}
  \tl_set:Nx \l_tmpb_tl { {\fp_use:N \l_tmpa_fp} {\fp_use:N \l_tmpb_fp} {\fp_use:N \l__penrose_tmpa_fp} {\fp_use:N \l_tmpa_fp}}
  \spath_get:nnN {#1} {initial point} \l_tmpa_tl
  \fp_set:Nn \l__penrose_tmpa_fp {(-1) * \l_tmpa_fp * \tl_head:N \l_tmpa_tl + (-1) * \l_tmpb_fp * \tl_tail:N \l_tmpa_tl}
  \fp_set:Nn \l_tmpb_fp {(-1) * \l_tmpa_fp * \tl_tail:N \l_tmpa_tl +  \l_tmpb_fp * \tl_head:N \l_tmpa_tl}
  \tl_put_right:Nx \l_tmpb_tl {{\fp_to_dim:N \l__penrose_tmpa_fp} {\fp_to_dim:N \l_tmpb_fp}}
  \spath_transform:nV {#1} \l_tmpb_tl
}
\penrose_normalise_path:n {Penrose path a}
\penrose_normalise_path:n {Penrose path b}

\NewDocumentCommand \SetPenrosePath { m }
{
  \pgfsyssoftpath@getcurrentpath\l_tmpa_tl
  \spath_clear_new:n {Penrose path #1}
  \spath_put:nnV {Penrose path #1} {path} \l_tmpa_tl
  \penrose_normalise_path:n {Penrose path a}
}

\cs_new_nopar:Npn \tikz_scan_point:n #1
{
  \tikz@scan@one@point\pgfutil@firstofone#1\relax
}

\cs_generate_variant:Nn \tikz_scan_point:n {V}

\cs_new_nopar:Npn \penrose_make_tile:nnn #1#2#3
{
  \spath_clone:nn {Penrose path a} {Penrose path A}
  \spath_clone:nn {Penrose path b} {Penrose path B}
  \spath_reverse:n {Penrose path A}
  \spath_reverse:n {Penrose path B}
  \spath_transform:nnnnnnn {Penrose path A} {-1} {0} {0} {-1} {1} {0}
  \spath_transform:nnnnnnn {Penrose path B} {-1} {0} {0} {-1} {1} {0}
  \tl_set:Nn \l_tmpa_tl {#3}
  \tl_set:Nx \l_tmpb_tl {\tl_head:N \l_tmpa_tl}
  \tl_set:Nn \l_tmpa_tl {\pgfsyssoftpath@movetotoken}
  \tikz_scan_point:V \l_tmpb_tl
  \tl_put_right:Nx \l_tmpa_tl {{\dim_use:N \pgf@x}{\dim_use:N \pgf@y}}
  \spath_clear_new:n {Penrose path tile}
  \spath_put:nnV {Penrose path tile #1} {path} \l_tmpa_tl
  \tl_set:Nn \l__penrose_tmpa_tl {#3}
  \tl_put_right:Nx \l__penrose_tmpa_tl {{\tl_head:N \l__penrose_tmpa_tl}}
  \tl_map_inline:nn {#2} {
    \spath_clone:nn {Penrose path ##1} {Penrose path tmpa}
    \tl_set:Nx \l_tmpb_tl {\tl_head:N \l__penrose_tmpa_tl}
    \tl_set:Nx \l__penrose_tmpa_tl {\tl_tail:N \l__penrose_tmpa_tl}
    \tikz_scan_point:V \l_tmpb_tl
    \fp_set:Nn \l_tmpa_fp { \pgf@x }
    \fp_set:Nn \l_tmpb_fp { \pgf@y }
    \tl_set:Nx \l_tmpb_tl {\tl_head:N \l__penrose_tmpa_tl}
    \tikz_scan_point:V \l_tmpb_tl
    \fp_set:Nn \l_tmpa_fp {\pgf@x - \l_tmpa_fp}
    \fp_set:Nn \l_tmpb_fp {\pgf@y - \l_tmpb_fp}
    \fp_set:Nn \l__penrose_tmpa_fp {-\l_tmpb_fp}
    \tl_set:Nx \l_tmpb_tl {{\fp_use:N \l_tmpa_fp} {\fp_use:N \l__penrose_tmpa_fp} {\fp_use:N \l_tmpb_fp} {\fp_use:N \l_tmpa_fp} {0} {0}}
    \spath_transform:nV {Penrose path tmpa} \l_tmpb_tl
    \spath_weld:nn {Penrose path tile #1} {Penrose path tmpa}
  }
}

\cs_new_nopar:Npn \penrose_make_tile:nn #1#2
{
  \penrose_make_tile:nnn {#1} #2
}

\cs_generate_variant:Nn \penrose_make_tile:nn {nV}

\prop_new:N \g__penrose_tiles_prop

\fp_set:Nn \l_tmpa_fp {cosd(18)}
\fp_set:Nn \l_tmpb_fp {sind(18)}

\cs_new_nopar:Npn \tl_add_coordinate:Nnn #1#2#3 {
  \fp_set:Nn \l_tmpa_fp{#2}
  \fp_set:Nn \l_tmpb_fp{#3}
  \tl_put_right:Nx #1 {{(\fp_use:N \l_tmpa_fp, \fp_use:N \l_tmpb_fp)}}
}

\tl_clear:N \l_tmpa_tl
\tl_add_coordinate:Nnn \l_tmpa_tl {0}{0}
\tl_add_coordinate:Nnn \l_tmpa_tl {cosd(18)}{sind(18)}
\tl_add_coordinate:Nnn \l_tmpa_tl {2*cosd(18)}{0}
\tl_add_coordinate:Nnn \l_tmpa_tl {cosd(18)}{-sind(18)}

\prop_gput:Nnx \g__penrose_tiles_prop {thin~ rhombus}  {{a A B b} {\tl_use:N \l_tmpa_tl}}

\tl_clear:N \l_tmpa_tl
\tl_add_coordinate:Nnn \l_tmpa_tl {0}{0}
\tl_add_coordinate:Nnn \l_tmpa_tl {cosd(36)}{sind(36)}
\tl_add_coordinate:Nnn \l_tmpa_tl {2*cosd(36)}{0}
\tl_add_coordinate:Nnn \l_tmpa_tl {cosd(36)}{-sind(36)}

\prop_gput:Nnx \g__penrose_tiles_prop {thick~ rhombus}  {{A b B a} {\tl_use:N \l_tmpa_tl}}

\tl_clear:N \l_tmpa_tl
\tl_add_coordinate:Nnn \l_tmpa_tl {0}{0}
\tl_add_coordinate:Nnn \l_tmpa_tl {2*sind(18)*cosd(108)}{2*sind(18)*sind(108)}
\tl_add_coordinate:Nnn \l_tmpa_tl {2*sind(18)}{0}
\tl_add_coordinate:Nnn \l_tmpa_tl {2*sind(18)*cosd(108)}{-2*sind(18)*sind(108)}

\prop_gput:Nnx \g__penrose_tiles_prop {dart}  {{B a A b} {\tl_use:N \l_tmpa_tl}}

\tl_clear:N \l_tmpa_tl
\tl_add_coordinate:Nnn \l_tmpa_tl {0}{0}
\tl_add_coordinate:Nnn \l_tmpa_tl {cosd(36)}{sind(36)}
\tl_add_coordinate:Nnn \l_tmpa_tl {1}{0}
\tl_add_coordinate:Nnn \l_tmpa_tl {cosd(36)}{-sind(36)}

\prop_gput:Nnx \g__penrose_tiles_prop {kite}  {{a B b A} {\tl_use:N \l_tmpa_tl}}



\NewDocumentCommand \MakePenroseTile {m}
{
  \prop_get:NnN \g__penrose_tiles_prop {#1} \l_tmpa_tl
  \penrose_make_tile:nV {#1} \l_tmpa_tl
}

\NewDocumentCommand \UsePenroseTile {O{} m} 
{
  \spath_clone:nn {Penrose path tile #2} {Penrose path tmpa}
  \pgfgettransform \l_tmpa_tl
  \tl_clear:N \l_tmpb_tl
  \tl_set:Nx \l_tmpb_tl {{\tl_head:N \l_tmpa_tl}}
  \tl_set:Nx \l_tmpa_tl {\tl_tail:N \l_tmpa_tl}
  \tl_put_right:Nx \l_tmpb_tl {{\tl_item:Nn \l_tmpa_tl {2}}}
  \tl_put_right:Nx \l_tmpb_tl {{\tl_item:Nn \l_tmpa_tl {1}}}
  \tl_set:Nx \l_tmpa_tl {\tl_tail:N \l_tmpa_tl}
  \tl_set:Nx \l_tmpa_tl {\tl_tail:N \l_tmpa_tl}
  \tl_put_right:NV \l_tmpb_tl \l_tmpa_tl
  \spath_transform:nV {Penrose path tmpa} \l_tmpb_tl
  \spath_protocol_path:n {Penrose path tmpa}
  \spath_tikz_path:nn {#1}{Penrose path tmpa}
}

\tikzset{
  save~ Penrose~ path/.code={
    \tikz@addmode{
      \pgfsyssoftpath@getcurrentpath\l_tmpa_tl
      \spath_clear_new:n {Penrose path #1}
      \spath_put:nnV {Penrose path #1} {path} \l_tmpa_tl
      \penrose_normalise_path:n {Penrose path #1}
    }
  }
}


\MakePenroseTile {thin~ rhombus}
\MakePenroseTile {thick~ rhombus} 
\MakePenroseTile {dart}
\MakePenroseTile {kite}

% Now let's try emulating the Lindenmayer system

\prop_new:N \g__penrose_rhombus_lms_rule_prop
\prop_put:Nnn \g__penrose_rhombus_lms_rule_prop {T} {[f*sT][f>g]}
\prop_put:Nnn \g__penrose_rhombus_lms_rule_prop {t} {[f_st][f>G]}
\prop_put:Nnn \g__penrose_rhombus_lms_rule_prop {G} {[f+sG][sf>g][sf*sT]}
\prop_put:Nnn \g__penrose_rhombus_lms_rule_prop {g} {[f-sg][sf>G][sf_st]}

\prop_new:N \g__penrose_default_lms_action_prop
\prop_new:N \g__penrose_rhombus_lms_action_prop
\dim_new:N \l__penrose_step_dim
\fp_new:N \l__penrose_scale_fp
\dim_set:Nn \l__penrose_step_dim {1cm}
\fp_set:Nn \l__penrose_scale_fp {1}

\prop_put:Nnn \g__penrose_default_lms_action_prop {[} {\group_begin:}
\prop_put:Nnn \g__penrose_default_lms_action_prop {]} {\group_end:}
\prop_put:Nnn \g__penrose_default_lms_action_prop {f} {\pgftransformxshift{\l__penrose_step_dim}}
\prop_put:Nnn \g__penrose_default_lms_action_prop {s} {\pgftransformscale{\fp_use:N \l__penrose_scale_fp}}

\prop_put:Nnn \g__penrose_rhombus_lms_action_prop {+} {\pgftransformrotate{144}}
\prop_put:Nnn \g__penrose_rhombus_lms_action_prop {*} {\pgftransformrotate{108}}
\prop_put:Nnn \g__penrose_rhombus_lms_action_prop {-} {\pgftransformrotate{216}}
\prop_put:Nnn \g__penrose_rhombus_lms_action_prop {_} {\pgftransformrotate{252}}
\prop_put:Nnn \g__penrose_rhombus_lms_action_prop {>} {\pgftransformrotate{180}}


\prop_put:Nnn \g__penrose_rhombus_lms_action_prop {s} {
  \fp_set:Nn \l_tmpa_fp { 2 * sind(18) * \l__penrose_step_dim }
  \dim_set:Nn \l__penrose_step_dim {\fp_to_dim:N \l_tmpa_fp}
}

\prop_put:Nnn \g__penrose_rhombus_lms_action_prop {T} {
  \group_begin:
  \pgftransformrotate{18}
  \fp_set:Nn \l_tmpa_fp {\l__penrose_step_dim/1cm}
  \pgftransformscale{\fp_use:N \l_tmpa_fp}
  \UsePenroseTile[every~ thin~ rhombus/.try]{thin~rhombus}
  \group_end:
}
\prop_put:Nnn \g__penrose_rhombus_lms_action_prop {G} {
  \group_begin:
  \pgftransformrotate{180}
  \pgftransformxshift{-\l__penrose_step_dim}
  \fp_set:Nn \l_tmpa_fp {\l__penrose_step_dim/1cm/(2*cosd(36))}
  \pgftransformscale{\fp_use:N \l_tmpa_fp}
  \UsePenroseTile[every~ thick~ rhombus/.try]{thick~rhombus}
  \group_end:
}


% #1 -> tl to store result in
% #2 -> name
% #3 -> number of iterations
% #4 -> initial state
\cs_new_nopar:Npn \penrose_make_lms:Nnnn #1#2#3#4
{
  \group_begin:
  \tl_set:Nn \l__penrose_tmpb_tl {#4}
  \prg_replicate:nn {#3} {
    \tl_set_eq:NN \l__penrose_tmpa_tl \l__penrose_tmpb_tl
    \tl_clear:N \l__penrose_tmpb_tl
    \tl_map_inline:Nn \l__penrose_tmpa_tl
    {
      \prop_if_in:cnTF {g__penrose_#2_lms_rule_prop} {##1}
      {
        \tl_put_right:Nx \l__penrose_tmpb_tl {\prop_get:cn {g__penrose_#2_lms_rule_prop} {##1} }
      }
      {
        \tl_put_right:Nn \l__penrose_tmpb_tl {##1}
      }
    }
  }
  \tl_set:Nn \l_tmpa_tl {
    \group_end:
    \tl_set:Nn #1
  }
  \tl_put_right:Nx \l_tmpa_tl {{\tl_use:N \l__penrose_tmpb_tl}}
  \tl_use:N \l_tmpa_tl
}

\cs_generate_variant:Nn \penrose_make_lms:Nnnn {Nnnx}

% #1 -> token list with result
% #2 -> name 
\cs_new_nopar:Npn \penrose_invoke_lms:Nn #1#2
{
  \group_begin:
  \tl_map_inline:Nn #1 {
    \prop_if_in:cnTF {g__penrose_#2_lms_action_prop} {##1}
    {
      \prop_get:cn {g__penrose_#2_lms_action_prop} {##1}
    }
    {
      \prop_if_in:cnT {g__penrose_default_lms_action_prop} {##1}
      {
        \prop_get:cn {g__penrose_default_lms_action_prop} {##1}
      }
    }
  }
  \group_end:
}

\NewDocumentCommand \PenroseDecomposition { m m m }
{
  \penrose_make_lms:Nnnx \l_tmpa_tl {#1} {#2} {#3}
  \penrose_invoke_lms:Nn \l_tmpa_tl {#1}
}

\ExplSyntaxOff

\tikzset{
  thin rhombus/.pic={
    \begin{scope}
    \pgfkeysgetvalue{/tikz/Penrose/alignment location}{\prloc}
    \ifx\prloc\pgfutil@empty
    \else
    \begingroup
    \tikzset{name prefix ..}%
    \tikz@scan@one@point\pgfutil@firstofone(\prloc-edge \pgfkeysvalueof{/tikz/Penrose/alignment edge} start)%
    \global\pgf@xa=\pgf@x
    \global\pgf@ya=\pgf@y
    \tikz@scan@one@point\pgfutil@firstofone(\prloc-edge \pgfkeysvalueof{/tikz/Penrose/alignment edge} end)%
    \global\pgf@xb=\pgf@x
    \global\pgf@yb=\pgf@y
    \endgroup
    \advance\pgf@xb by -\pgf@xa
    \advance\pgf@yb by -\pgf@ya
    \pgftransformshift{\pgfpoint{\pgf@xa}{\pgf@ya}}%
    \pgfpointnormalised{\pgfpoint{\pgf@xb}{\pgf@yb}}
    \pgf@xb=\pgf@x
    \pgf@yb=\pgf@y
\pgftransformtriangle{\pgfpoint{0pt}{0pt}}{\pgfpoint{\pgf@xb}{\pgf@yb}}{\pgfpoint{-\pgf@yb}{\pgf@xb}}
    \if\pgfkeysvalueof{/tikz/Penrose/alignment edge}b\relax
    \pgftransformrotate{-162}%
    \pgftransformshift{\pgfpoint{-2*\pr@chphi cm}{0 cm}}%
    \else
    \if\pgfkeysvalueof{/tikz/Penrose/alignment edge}B\relax
    \pgftransformrotate{-18}%
    \else
    \if\pgfkeysvalueof{/tikz/Penrose/alignment edge}a\relax
    \pgftransformrotate{162}%
    \pgftransformshift{\pgfpoint{-2*\pr@chphi cm}{0 cm}}%
    \else
    \if\pgfkeysvalueof{/tikz/Penrose/alignment edge}A\relax
    \pgftransformrotate{18}%
    \fi\fi\fi\fi
    \fi
    \UsePenroseTile[clip]{thin rhombus}
    \UsePenroseTile[every thin rhombus/.try, pic actions]{thin rhombus}
\path[every circle arc/.try] (18:1) circle[radius=1/4];
\path[every long arc/.try] (-18:1) circle[radius=1/4];
\coordinate (-edge a start) at (0,0);
\coordinate (-edge b start) at (0,0);
\coordinate (-edge b end) at (18:1);
\coordinate (-edge B end) at (18:1);
\coordinate (-edge A start) at (2*\pr@chphi,0);
\coordinate (-edge B start) at (2*\pr@chphi,0);
\coordinate (-edge a end) at (-18:1);
\coordinate (-edge A end) at (-18:1);
    \end{scope}
  },
  thin rhombus/.style={
    every Penrose tile/.try,
    pic type=thin rhombus,
  },
  thick rhombus/.pic={
    \begin{scope}
    \pgfkeysgetvalue{/tikz/Penrose/alignment location}{\prloc}
    \ifx\prloc\pgfutil@empty
    \else
    \begingroup
    \tikzset{name prefix ..}%
    \tikz@scan@one@point\pgfutil@firstofone(\prloc-edge \pgfkeysvalueof{/tikz/Penrose/alignment edge} start)%
    \global\pgf@xa=\pgf@x
    \global\pgf@ya=\pgf@y
    \tikz@scan@one@point\pgfutil@firstofone(\prloc-edge \pgfkeysvalueof{/tikz/Penrose/alignment edge} end)%
    \global\pgf@xb=\pgf@x
    \global\pgf@yb=\pgf@y
    \endgroup
    \advance\pgf@xb by -\pgf@xa
    \advance\pgf@yb by -\pgf@ya
    \pgftransformshift{\pgfpoint{\pgf@xa}{\pgf@ya}}%
    \pgfpointnormalised{\pgfpoint{\pgf@xb}{\pgf@yb}}
    \pgf@xb=\pgf@x
    \pgf@yb=\pgf@y
\pgftransformtriangle{\pgfpoint{0pt}{0pt}}{\pgfpoint{\pgf@xb}{\pgf@yb}}{\pgfpoint{-\pgf@yb}{\pgf@xb}}
    \if\pgfkeysvalueof{/tikz/Penrose/alignment edge}b\relax
    \pgftransformrotate{144}%
    \pgftransformshift{\pgfpoint{-\pr@cphi cm}{-\pr@sphi cm}}%
    \else
    \if\pgfkeysvalueof{/tikz/Penrose/alignment edge}B\relax
    \pgftransformrotate{216}%
    \pgftransformshift{\pgfpoint{-\pr@cphi cm}{\pr@sphi cm}}%
    \else
    \if\pgfkeysvalueof{/tikz/Penrose/alignment edge}a\relax
    \pgftransformrotate{144}%
    \pgftransformshift{\pgfpoint{-2*\pr@cphi cm}{0 cm}}%
    \else
    \if\pgfkeysvalueof{/tikz/Penrose/alignment edge}A\relax
    \pgftransformrotate{216}%
    \pgftransformshift{\pgfpoint{-2*\pr@cphi cm}{0 cm}}%
    \fi\fi\fi\fi
    \fi
    \UsePenroseTile[clip]{thick rhombus}
    \UsePenroseTile[every rhombus/.try, every thick rhombus/.try, pic actions]{thick rhombus}
\path[every circle arc/.try] (0,0) circle[radius=1/4];
\path[every long arc/.try] (2*\pr@cphi,0) circle[radius=3/4];
\coordinate (-edge b end) at (0,0);
\coordinate (-edge B end) at (0,0);
\coordinate (-edge a end) at (36:1);
\coordinate (-edge B start) at (36:1);
\coordinate (-edge a start) at (2*\pr@cphi,0);
\coordinate (-edge A start) at (2*\pr@cphi,0);
\coordinate (-edge A end) at (-36:1);
\coordinate (-edge b start) at (-36:1);
    \end{scope}
  },
  thick rhombus/.style={
    every Penrose tile/.try,
    pic type=thick rhombus,
  },
  align with/.code args={#1 along #2}{%
    \tikzset{
      Penrose/alignment location=#1,
      Penrose/alignment edge=#2,
    }%
  },
  Penrose/alignment location/.initial={},
  Penrose/alignment edge/.initial=a,
  kite/.pic={
    \begin{scope}
    \pgfkeysgetvalue{/tikz/Penrose/alignment location}{\prloc}
    \ifx\prloc\pgfutil@empty
    \else
    \begingroup
    \tikzset{name prefix ..}%
    \tikz@scan@one@point\pgfutil@firstofone(\prloc-edge \pgfkeysvalueof{/tikz/Penrose/alignment edge} start)%
    \global\pgf@xa=\pgf@x
    \global\pgf@ya=\pgf@y
    \tikz@scan@one@point\pgfutil@firstofone(\prloc-edge \pgfkeysvalueof{/tikz/Penrose/alignment edge} end)%
    \global\pgf@xb=\pgf@x
    \global\pgf@yb=\pgf@y
    \endgroup
    \advance\pgf@xb by -\pgf@xa
    \advance\pgf@yb by -\pgf@ya
    \pgftransformshift{\pgfpoint{\pgf@xa}{\pgf@ya}}%
    \pgfpointnormalised{\pgfpoint{\pgf@xb}{\pgf@yb}}
    \pgf@xb=\pgf@x
    \pgf@yb=\pgf@y
\pgftransformtriangle{\pgfpoint{0pt}{0pt}}{\pgfpoint{\pgf@xb}{\pgf@yb}}{\pgfpoint{-\pgf@yb}{\pgf@xb}}
    \if\pgfkeysvalueof{/tikz/Penrose/alignment edge}b\relax
    \pgftransformrotate{108}%
    \pgftransformshift{\pgfpoint{-1 cm}{0 cm}}%
    \else
    \if\pgfkeysvalueof{/tikz/Penrose/alignment edge}B\relax
    \pgftransformrotate{-108}%
    \pgftransformshift{\pgfpoint{-1 cm}{0 cm}}%
    \else
    \if\pgfkeysvalueof{/tikz/Penrose/alignment edge}a\relax
    \pgftransformrotate{36}%
    \else
    \if\pgfkeysvalueof{/tikz/Penrose/alignment edge}A\relax
    \pgftransformrotate{-36}%
    \fi\fi\fi\fi
    \fi
    \UsePenroseTile[clip]{kite}
    \UsePenroseTile[every kite/.try, pic actions]{kite}
\path[every circle arc/.try] (0,0) circle[radius=\pr@invphi];
\path[every long arc/.try] (1,0) circle[radius=\pr@invphisq];
\coordinate (-edge a start) at (0,0);
\coordinate (-edge A start) at (0,0);
\coordinate (-edge a end) at (36:1);
\coordinate (-edge b end) at (36:1);
\coordinate (-edge b start) at (1,0);
\coordinate (-edge B start) at (1,0);
\coordinate (-edge A end) at (-36:1);
\coordinate (-edge B end) at (-36:1);
    \end{scope}
  },
  dart/.pic={
    \begin{scope}
    \pgfkeysgetvalue{/tikz/Penrose/alignment location}{\prloc}
    \ifx\prloc\pgfutil@empty
    \else
    \begingroup
    \tikzset{name prefix ..}%
    \tikz@scan@one@point\pgfutil@firstofone(\prloc-edge \pgfkeysvalueof{/tikz/Penrose/alignment edge} start)%
    \global\pgf@xa=\pgf@x
    \global\pgf@ya=\pgf@y
    \tikz@scan@one@point\pgfutil@firstofone(\prloc-edge \pgfkeysvalueof{/tikz/Penrose/alignment edge} end)%
    \global\pgf@xb=\pgf@x
    \global\pgf@yb=\pgf@y
    \endgroup
    \advance\pgf@xb by -\pgf@xa
    \advance\pgf@yb by -\pgf@ya
    \pgftransformshift{\pgfpoint{\pgf@xa}{\pgf@ya}}%
    \pgfpointnormalised{\pgfpoint{\pgf@xb}{\pgf@yb}}
    \pgf@xb=\pgf@x
    \pgf@yb=\pgf@y
\pgftransformtriangle{\pgfpoint{0pt}{0pt}}{\pgfpoint{\pgf@xb}{\pgf@yb}}{\pgfpoint{-\pgf@yb}{\pgf@xb}}
    \if\pgfkeysvalueof{/tikz/Penrose/alignment edge}b\relax
    \pgftransformrotate{-72}%
    \pgftransformshift{\pgfpoint{\pr@invphi*\pr@shphi cm}{\pr@invphi*\pr@chphi cm}}%
    \else
    \if\pgfkeysvalueof{/tikz/Penrose/alignment edge}B\relax
    \pgftransformrotate{72}%
    \pgftransformshift{\pgfpoint{\pr@invphi*\pr@shphi cm}{-\pr@invphi*\pr@chphi cm}}%
    \else
    \if\pgfkeysvalueof{/tikz/Penrose/alignment edge}a\relax
    \pgftransformrotate{-36}%
    \pgftransformshift{\pgfpoint{\pr@invphi*\pr@shphi cm}{\pr@invphi*\pr@chphi cm}}%
    \else
    \if\pgfkeysvalueof{/tikz/Penrose/alignment edge}A\relax
    \pgftransformrotate{36}%
    \pgftransformshift{\pgfpoint{\pr@invphi*\pr@shphi cm}{-\pr@invphi*\pr@chphi cm}}%
    \fi\fi\fi\fi
    \fi
    \UsePenroseTile[clip]{dart}
    \UsePenroseTile[every dart/.try, pic actions]{dart}
\path[every circle arc/.try] (\pr@invphi,0) circle[radius=\pr@ominvphi];
\path[every long arc/.try] (0,0) circle[radius=\pr@ominvphisq];
\coordinate (-edge b end) at (0,0);
\coordinate (-edge B end) at (0,0);
\coordinate (-edge a start) at (108:\pr@invphi);
\coordinate (-edge b start) at (108:\pr@invphi);
\coordinate (-edge a end) at (\pr@invphi,0);
\coordinate (-edge A end) at (\pr@invphi,0);
\coordinate (-edge A start) at (-108:\pr@invphi);
\coordinate (-edge B start) at (-108:\pr@invphi);
    \end{scope}
  },
  kite/.style={
    every Penrose tile/.try,
    pic type=kite,
  },
  dart/.style={
    every Penrose tile/.try,
    pic type=dart,
  },
  Penrose/.is family,
  Penrose/.cd,
  Penrose/set path/.code={
    \pgf@relevantforpicturesizefalse
    \tikz@addmode{
      \pgfsyssoftpath@getcurrentpath\pr@temp
      \MakeSPath{Penrose path #1}{\pr@temp}%
      \SPathPrepare{Penrose path #1}%
      \pgfusepath{discard}%
    },
  },
}

